## 一 Zookeeper是什么
Zookeeper是一个分布式协调服务，主要用于分布式系统中Leader选举、配置管理、集群管理、分布式锁等场景  


## 二 Zookeeper数据模型
Zookeeper 的数据结构类似于一个文件系统，使用 ZNode 构建成一颗树，每个 ZNode 可以存储少量数据和子节点  
支持 4 种节点类型：持久节点、临时节点、持久顺序节点、临时顺序节点  


## 三 Zookeeper的ZAB协议
### 3.1 什么是ZAB协议
✅ ZAB协议就是Zookeeper Atomic Broadcast原子关广播协议，他主要包括2个阶段: 崩溃恢复阶段和消息广播阶段  

### 3.2 ZAB协议有哪些角色
✅ Follower: 节点启动默认角色，参与选举; 负责从Leader同步数据和处理读请求; 如果是写请求需要转发给Leader处理  
✅ Leader: 选举的新的主节点，负责读写请求；并且将写请求封装成事务，然后写入本地；并且同步给Follower  
✅ Observer: 负责从Leader同步数据和处理读请求;如果是写请求需要转发给Leader处理; 不参与选举  

### 3.3 崩溃恢复阶段
🧠 **进入崩溃恢复阶段时机:**  
✅ 集群启动  
✅ Leader重启  
✅ Leader宕机  

🧠 **崩溃恢复流程:**  
✅ Follower选举Leader(zxid最大，如果相同采用myid)  
✅ Leader当选后进入数据同步阶段:  
➡️ Follower 会将自身最大 zxid 上报给 Leader  
➡️ Leader 根据差异:  
1. [ ] 如果 Follower 数据比Leader新，会强制Follower回滚  
2. [ ] 如果 Follower 数据旧，会补齐数据(差异事务日志)  

✅ 所有 Follower 同步完成后，进入 **广播模式**，Leader 对外提供服务  

### 3.4 消息广播阶段
✅ 接收读写请求，读请求可以落在Leader或者Follower甚至Observer  
✅ 如果是写请求，如果不是Leader需要先转发请求到Leader  
✅ Leader收到请求封装成事务，写入本地，状态未提交，然后向Follower发送事务  
✅ Follower同步事务，写入本地，响应Leader  
✅ Leader收到半数以上Follower响应，Leader 标记本地事务为“已提交”，并向 Follower 发送 COMMIT  

## 四 什么是 Zookeeper 的 Watcher？怎么使用？
✅ Watcher 是一种注册在 ZNode 上的回调机制，用于监听数据或节点变化。一旦触发，客户端会接收到通知。**需要注意：**   
1. [ ] Watch 是一次性的
2. [ ] 客户端需重新注册
3. [ ] 不保证实时性，但保证顺序性  


## 五 Zookeeper实现分布式锁的方案

🔍 **结论:**
💡 **是否有死锁?**
持有锁的客户端进程挂了，那么会话到期，这个节点就会自动被删除，所以不存在死锁，所以不需要设置超时时间

💡 **是否需要续租?**
因为没有锁超时问题，不存在业务没有执行完锁就释放的场景，所以也不需要续租

💡 **否单点故障?**
Zookeeper一般集群部署，就不存在单点故障

💡 **是否通知其他进程？**
锁删除的时候会通知其他进程

### 5.1 无序临时节点
✅ 在某一个目录下，客户端进程需要创建一个临时节点，创建成功，表示获取到锁；创建失败，表示锁已存在  
✅ 失败的进程会注册一个Watcher去监听这个节点，如果别人释放锁的时候，就会被通知  
✅ 持有锁的线程删除这个锁，就是释放锁，别的客户端因为监听这个节点，所以会被通知  
✅ 被通知后，这些客户端进程又开始向这个目录下创建临时节点，去获取锁

❗ **缺点:**  
🔵 **羊群效应**  
所有获取锁失败的客户端都会在父节点上创建对子节点的监听，当持有锁的客户端释放锁之后，所有等待的进程一起来创建节点，并发量很大，每次都这样，乱糟糟的，所以也叫羊群效应

🔵 **锁不公平**  
可能后面的进程先于前面等待的进程先获取到锁，不是公平锁，所以可能造成饥饿现象


### 5.2 有序临时节点

✅ 客户端在某路径下创建临时有序节点，会根据指定的锁的前缀 + 生成一个数字序号，这个数字序号是递增的  
✅ 每一个客户端创建后判断自己是不是第一个有序节点，如果是获取锁，且不需要注册监听器  
✅ 如果不是，则监听“前一个”节点添加Watcher监听器，监听删除事件  
✅ 当持有锁的客户端释放锁或者宕机的的时候，监听器就会被通知，判断自己是不是第一个有序节点，如果是获取锁

❗**优点:** 解决了无需节点的羊群效应和不公平的问题  