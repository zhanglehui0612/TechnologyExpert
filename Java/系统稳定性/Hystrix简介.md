## 一 Hystrix是什么
Hystrix是Netflix开源的一个分布式容错框架。他提供了熔断降级，有助于阻止级联故障，保证当前服务的可用性  
Hystrix有两种工作模式: 线程池和信号量。其中线程池是默认模式：  
* 线程池：请求到来，从Hystrix线程池获取线程执行。如果线程池满了，没有额外的线程执行则会进行降级
* 信号量：请求到来，获取信号量，如果没有信号量则进行降级处理; 如果有，使用完之后需要返还给Hystrix

默认情况下Hystrix只有一个线程池，如果在并发量高的时候，可能很容易被某个高频打满了，从而影响到其他服务或者接口。因此，一般线程池最好针对服务或者接口单独设置线程池  


## 二 Hystrix工作原理
1. Hystrix通过AOP的方式，对添加了@HsytrixCommand和@HystrixObservableCommand注解的地方进行拦截
2. 解析注解信息，生成HystrixCommand或者HystrixObservableCommand对象，用于封装请求
3. 执行命令
4. 判断是否启用缓存，没启用不用管，一般也不会启用这个
5. 判断circuitbreaker断路器是否打开，如果打开，统计熔断监控指标，然后走fallback降级
6. 如果没有打开，则判断线程池、信号量是否已满，如果已满则走fallback降级
7. 统计熔断监控指标

## 三 Hystrix断路器工作原理
### 3.1 状态
断路器一共存在三种状态: Closed、Open、Half-Open  
1. [ ] Closed（闭合）：正常状态，请求可以通过
2. [ ] Open（打开）：熔断状态，请求直接失败，触发降级
3. [ ] Half-Open（半开）：试探恢复状态，允许少量请求测试是否恢复

### 3.2 如果是Closed闭合状态
1. 每次请求会被记录并统计其成功或失败。
2. 在默认的10 秒统计窗口内，Hystrix 会累计请求次数。
3. 如果请求数未达到 circuitBreaker.requestVolumeThreshold（默认 20），则不触发熔断判断。
4. 如果达到请求阈值，会计算失败率。
5. 如果失败率超过 circuitBreaker.errorThresholdPercentage（默认 50%），则断路器转为 Open 状态，开始熔断。
6. 熔断后后续请求会直接拒绝，走 fallback 或抛出异常。

### 3.3 如果是Open状态
请求到来时，Hystrix 检查断路器是否为 Open  
如果是 Open，则判断**熔断时间窗口（默认 5 秒）**是否已到：  
* 如果未到，拒绝请求，触发 fallback
* 如果已到，Hystrix 会允许少量请求探测（进入 Half-Open 状态）

### 3.4 如果是Half-Open状态
允许少量请求进入（一般是单个请求，Hystrix 不做并发探测） 
如果探测请求执行成功（服务正常），断路器状态切换为 Closed  
如果探测请求仍然失败，断路器状态重新转为 Open，进入新一轮熔断期  



## 四 线程池模式和信号量模式区别
### 4.1 是否支持超时
线程池模式支持超时；信号量模式不支持  

### 4.2 资源消耗
线程池模式占用线程资源大；信号量模式较少  

### 4.3 隔离性
线程池模式隔离性强; 信号量模式隔离性弱   

### 4.4 是否异步
线程池模式异步执行；信号量模式同步执行  