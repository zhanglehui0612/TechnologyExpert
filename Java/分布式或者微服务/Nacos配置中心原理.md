## 一 Nacos介绍
Nacos除了可以作为服务注册中心，还可以作为配置中心  
Nacos采取Raft协议来处理数据  

## 二 Nacos配置中心工作原理
### 2.1 Leader接收配置变更请求
✅ 用户通过控制台、API、或者命令行提交配置新增、修改、删除请求  
✅ 服务端接收请求后进行合法性校验（如 dataId、group、命名空间是否合规）  

### 2.2 持久化存储配置
✅ 将配置内容写入持久化存储默认嵌入式数据库，支持 MySQL 等外部存储  

### 2.3 维护内存缓存
✅ 配置变更后，更新服务端内存缓存(加速读取)  
✅ 缓存是配置的热数据，确保读取性能和变更通知的及时性  

### 2.4 配置变更广播和通知
✅ 变更配置后，服务端主动通知所有订阅了该配置的客户端  
✅ 通过长连接(HTTP长轮询或WebSocket)向客户端推送配置变更通知  

### 2.5 同步数据到其他Nacos节点
✅ 因为Leader处理数据后，已经在本地操作完了，这时候需要把数据同步给其他节点  
✅ 超过半数以上的节点确认，才认为这个配置写入成功  

### 2.6 处理客户端订阅
✅ 维护客户端订阅关系, 哪些客户端关注哪些配置  
✅ 接受客户端订阅请求，保持长连接以便推送配置变更  

## 三 配置客户端工作机制
### 3.1 启动时订阅配置
✅ 客户端应用启动时，通过 Nacos SDK 向 Nacos Server 发起配置订阅请求
✅ 订阅时需要指定命名空间、分组和dataId：
1. [ ] namespace（命名空间）
2. [ ] group（配置分组）
3. [ ] dataId（配置标识）

✅ 客户端建立长连接（HTTP 长轮询或 WebSocket）与服务端保持通信，准备接收配置变更通知

### 3.2 本地缓存配置
✅ 客户端会在本地持久化一份配置缓存，保证即使网络异常或 Nacos 服务短暂不可用，应用依然能读取到最近的有效配置  

### 3.3 监听配置变更
✅ Nacos Server 会主动推送配置变更通知给客户端  
✅ 客户端收到通知后，主动调用拉取接口拉取最新配置内容，更新本地缓存  

### 3.4 热加载配置
✅ 客户端通过注册的监听器（Listener）回调，通知应用层配置已更新  
✅ 应用层根据回调，实现配置热更新，动态调整运行参数，无需重启  

### 3.5 故障恢复和重试
✅ 客户端如果失去与服务器的连接，会自动进行重连和重试  
✅ 当服务端恢复后，客户端会重新订阅，并同步最新配置  


## 四 长轮询
### 4.1 什么是长轮询
长轮询是一种客户端主动发起请求后，服务端不会立即响应，而是保持该请求连接，直到有新的数据变化或达到超时，才返回响应


### 4.2 长轮询工作机制
✅ 客户端发起请求，告诉服务端“我想订阅某个配置的变化”  
✅ 服务端接收到请求后，如果没有配置变更，就不立即返回响应，而是保持连接（等待状态）  
✅ 一旦该配置有更新，服务端立即返回最新版本信息给客户端  
✅ 客户端收到响应后，立刻再次发起新的长轮询请求，保持持续监听  

## 四 性能优化
### 4.1 长轮询参数调整
nacos.naming.load.cache.atleast.interval
说明：控制长轮询拉取配置的最短间隔。
优化建议：线上建议设置在 3000ms以上，避免请求过于频繁导致服务端压力增大。

nacos.core.remote.long-polling.timeout
说明：长轮询连接的超时时间。
优化建议：设置为 30秒左右，太短会导致频繁重连，太长可能延迟感知变更。

### 4.2 实际调优案例
案例一: 某线上集群心跳压力大，调整心跳间隔从5秒调到8秒，心跳超时相应调整到24秒，集群压力明显下降，且感知延迟仍在可接受范围内。
案例二：缓存拉取间隔从3秒调到5秒，推送延迟略增，但服务器负载下降20%。
案例三：定时调度间隔调大，线程池适当扩容，避免了因任务堆积导致的服务响应卡顿。

## 五 SpringCloud Config 、Apollo、Nacos配置中心选型
### 5.1 单机吞吐量(可选)
✅ SpringCloud Config: 几个每秒, 很差  
✅ Apollo: 高  
✅ Nacos: 高  

### 5.2 版本管理
✅ SpringCloud Config: 支持(Git)  
✅ Apollo: 自动管理  
✅ Nacos: 自动管理  

### 5.3 配置回滚
✅ SpringCloud Config: 支持(Git)  
✅ Apollo: 支持   
✅ Nacos: 支持  

### 5.4 灰度发布
✅ SpringCloud Config: 支持  
✅ Apollo: 支持  
✅ Nacos: 支持  

### 5.5 多环境支持
✅ SpringCloud Config: 支持  
✅ Apollo: 支持  
✅ Nacos: 支持  

### 5.6 权限管理
✅ SpringCloud Config: 支持  
✅ Apollo: 支持  
✅ Nacos: 支持， Nacos 2.x 版本或开启鉴权机制时，它具备较完善的权限控制体系  

### 5.7 多语言支持
✅ SpringCloud Config: 只支持Java   
✅ Apollo: 支持多种语言  
✅ Nacos: 支持多种语言  

### 5.8 实时推送
✅ SpringCloud Config: 支持(spring cloud bus)  
✅ Apollo: 支持(http 长轮询)  
✅ Nacos: 支持(http 长轮询)  

### 5.9 格式校验
✅ SpringCloud Config: 不支持  
✅ Apollo: 支持  
✅ Nacos: 支持



### 5.10  运维复杂度
✅ SpringCloud Config: ConfigServer (2) + Git + MQ (复杂度中等)
✅ Apollo: ConfigService(2) + AdminService(3) + Portal (2) + Eureka(3) + MySQL (复杂)
✅ Nacos: Nacos(3) + MySQL(简单)



### 5.11 通信协议
✅ SpringCloud Config: HTTP 
✅ Apollo: HTTP 
✅ Nacos: HTTP

