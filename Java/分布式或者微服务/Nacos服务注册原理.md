## 一 服务注册中心
### 1.1 为什么需要服务注册中心
✅ 屏蔽服务调用细节  
✅ 方便服务集中管理和监控

### 1.2 服务注册与发现需要哪些角色
#### 1.2.1 服务提供者
✅ 服务注册  
✅ 发送心跳进行续租  
✅ 服务下线发送通知

#### 1.2.2 服务消费者
✅ 从服务注册中心拉取服务，比如定时拉取服务，根据服务状态检测和更新本地服务列表  
✅ 本地维护一个服务缓存，防止服务注册中心不可用，无法拉取到服务

#### 1.2.3 服务注册中心
✅ 维护服务注册表，进行服务注册  
✅ 判断服务提供者是否及时续租，将不可用的服务实例剔除；更新服务注册列表  
✅ 对外提供服务注册和获取的接口  
✅ 服务监视  


## 二 Nacos概述
✅ Nacos是阿里巴巴开源一款的可以用于服务注册发现和配置中心的框架  
✅ Nacos提供了服务注册与发现、心跳与故障检测、配置管理、服务监控等功能    
✅ Nacos作为服务注册中心，属于CAP模型中的AP模型  
✅ Nacos通过Distro协议集群部署，Distro 协议是一种将服务注册数据按责任节点分片管理、通过异步副本同步实现最终一致性的高性能注册中心集群协议 

## 三 Distro协议
**Distro 协议本质上是一个基于 P2P 思想的分布式一致性协议:**  
🟢 每一个节点是对等的  
🟡 服务数据在节点间进行分区（分片）管理，对于服务要进行分区，某一个Nacos实例只负责一部分服务，如果不是所负责的服务数据，写请求会转发到对应服务的责任节点  
🔴 每一个服务进行hashcode计算或者其他算法一定会对应到一个Nacos实例，这个Nacos就是责任节点  
🟣 责任节点负责该服务的写请求，比如注册、心跳等等  
🟢 本节点操作完后，将数据同步给其他Nacos节点  
🟡 最终整个集群数据是一致的，也就是保证数据最终一致性  


## 四 服务端工作原理
### 4.1 服务服务注册端工作原理
✅ 服务端接收客户端请求  
✅ 根据服务名哈希或者其他算法确定该服务属于哪一个节点管理  
✅ 判断责任归属，如果当前节点就是责任节点，就直接开始处理，维护本地服务注册表；如果不是，则转发到他的责任节点  
✅ 将处理结果异步副本广播到其他节点  

### 4.2 心跳和故障检测
✅ 客户端发送心跳  
✅ 客户端默认5秒钟会向服务端节点发送心跳请求，心跳内容通常包括：服务实例 ID、状态、元数据等   
✅ 服务端收到请求后，更新服务注册表，每一个服务实例都会记录最近更新时间戳  
✅ 服务端定时进行超时检测，默认每隔5秒检查所有实例的心跳时间戳，是否有实例15秒钟都没有更新  
✅ 一旦超时，责任节点会将该实例标记为不健康状态  
✅ 如果超时时间继续增加(比如超过 30 秒)，会执行剔除操作,即从服务列表中移除  
✅ 责任节点变更了服务状态后，会异步将这个变更同步到其他节点  

## 五 服务提供者工作机制
✅ 向服务端发起注册请求  
✅ 向服务端(责任节点)定时发送心跳请求，默认5秒钟发送一次  


## 六 服务消费者工作机制
✅ 启动后会向注册中心拉取服务实例列表 ，然后缓存在本地  
✅ 一旦服务提供者上下线或健康状态变更，Nacos 会推送变更事件  
✅ 客户端自动更新本地缓存  
✅ 调用时，从本地缓存中选择一个健康实例发起请求  
✅ 如果目标实例不可达，客户端可以自动尝试下一个可用实例  

## 七 服务注册中心选型
### CAP模型和一致性
✅ eureka: AP模型, 弱一致性，服务注册可能有延迟或丢失    
✅ nacos: CP + AP 模型，满足最终一致性  
✅ zookeeper: CP模型，强一致性  
✅ etcd: CP模型，强一致性  
✅ consul: CP模型，强一致性

### 社区与维护状态
✅ eureka: Netflix已停止更新  
✅ nacos: 阿里开源，持续维护，尤其在国内  
✅ zookeeper: 成熟但较老，复杂度高  
✅ etcd: K8s 核心，仍在维护  
✅ consul: 活跃，由 HashiCorp 维护

### 语言
✅ eureka: Java语言  
✅ nacos: Java语言  
✅ zookeeper: Java语言  
✅ consul: Go语言  
✅ etcd: Go语言

### 部署复杂度
✅ eureka: 简单，单节点即可部署  
✅ nacos: 中等，支持单机和集群部署  
✅ consul: 中等，支持集群部署  
✅ zookeeper: 高（依赖 Java 环境+选主机制）  
✅ etcd: 高(需部署集群，网络要求高)

### 支持配置中心
✅ eureka: 不支持  
✅ nacos: 支持  
✅ consul: 不支持   
✅ zookeeper: 不支持   
✅ etcd: 不支持

### 多注册中心
✅ eureka: 不支持
✅ nacos: 命名空间隔离  
✅ consul: 多数据中心  
✅ zookeeper: 不支持  
✅ etcd: 支持

### 性能 & 成熟度
✅ eureka: 较旧，Netflix 已弃用  
✅ nacos: 高, 阿里已验证  
✅ consul: 高，可用于跨数据中心  
✅ zookeeper: 一般    
✅ etcd: 高，k8s底座

### 适用技术栈
✅ eureka: Java 微服务、轻量级系统
✅ nacos: Java服务，国内企业应用，服务注册 + 配置中心，特别适合Spring Cloud Alibaba技术栈
✅ consul: 语言服务注册、K8s 辅助组件、服务网格场景
✅ zookeeper: 配置协调、任务调度、分布式锁等   
✅ etcd: 云原生服务发现、K8s、存储配置型数据