# 专题: QPS 到了 10w，系统瓶颈在哪里？怎么优化?

## 一 系统瓶颈在哪里
当系统 QPS 达到 10w，我会先从链路各层排查瓶颈。请求的链路大约会经过: 网关 -> 应用 ->  数据库/缓存/消息队列这样的流程。  

### 1.1 网关层瓶颈
Nginx、API Gateway 的连接被打满，导致连接池耗尽

### 1.2 网络IO瓶颈
带宽/包大小/序列化慢，导致数据传输延迟，接口卡顿

### 1.3 应用层
应用实例资源不足，线程池打满、CPU飙升、内存飙升，导致响应变慢、接口超时、频繁 GC

### 1.4 缓存
如果不是本地缓存，可能会频繁访问缓存导致QPS 飙高、延迟大;
另外还增加了出现缓存雪崩、穿透和击穿的风险

### 1.5 数据库
数据库可能出现连接不够、慢SQL和锁争用以及资源瓶颈(cpu、内存、磁盘)等问题

### 1.6 消息队列	
如果是写入到消息队列，会产生积压，导致MQ 延迟上升、消息堆积


## 二 怎么优化

### 2.1 网关层
* 对于Nginx而言，检查当前配置是否已经达到极限，worker进程数量是否还可以再增加、最大连接数是否还可以增加等。如果已经是极限，那就通过增加机器来解决问题。  
* 对于API网关或者微服务网关而言, 通过增加网关实例数量来分担流量压力。  

### 2.2 应用层
* 首先, 看单个服务实例是否还有优化余地，比如优化Tomcat最大线程数等等，JVM参数优化
* 其次, 如果单个实例无法优化，看是否允许牺牲流量，如果允许牺牲流量，则可以进行限流操作 
* 然后, 如果不允许牺牲流量, 那么就横向扩容，多副本部署

### 2.3  数据库层优化
* 连接数满: 数据库最大连接是否可以增加，然后应用层数据库连接池进行参数优化
* SQL慢: 	 加索引、SQL 重写、分页优化、JOIN 拆分
* 承压高:	热点数据缓存、读写分离、分库分表
* 锁竞争: 避免大事务，减小锁粒度

### 2.4 缓存层优化：
* 缓存命中率低:	提前预热数据、设置合理 TTL
* 缓存穿透:	增加空值缓存 + 布隆过滤器
* 缓存击穿:	热点 Key 加互斥锁或预热策略
* 缓存雪崩:	Key 过期时间加随机抖动、使用隔离策略

### 2.5 消息队列优化
* 消息积压:	增加消费线程、并发消费、批量处理
* 消息丢失:	加确认机制（ACK）、事务消息
* MQ 阻塞: 	分 topic、分队列、限流